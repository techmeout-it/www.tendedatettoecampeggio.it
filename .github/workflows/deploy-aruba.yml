name: Deploy to Aruba via FTP

on:
  push:
    branches: ["main"]
  workflow_dispatch:

concurrency:
  group: deploy-aruba
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install
        run: npm ci

      - name: Build
        run: npm run build

      - name: Write build info
        run: |
          echo "Deployed commit: $GITHUB_SHA" > dist/deploy.txt
          echo "Deployed at: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> dist/deploy.txt

      - name: Install lftp
        run: sudo apt-get update && sudo apt-get install -y lftp

      - name: Deploy via FTP
        run: |
          lftp -u "${{ secrets.ARUBA_FTP_USER }},${{ secrets.ARUBA_FTP_PASS }}" \
            -e "set ftp:passive-mode yes; set ssl:verify-certificate no; set ftp:ssl-allow no; mirror -R --verbose --delete dist/ /httpdocs/; quit" \
            ftp://${{ secrets.ARUBA_FTP_SERVER }}
